<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Power Cut Detecting System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
  background-color: #000;
  color: #fff;
  text-align: center;
  padding: 50px;
}
h1 { color: #00ffea; margin-bottom: 40px; }
.form-control {
  background-color: #111;
  color: #fff;
  border: 1px solid #00ffea;
  border-radius: 10px;
  text-align: center;
  font-weight: bold;
  margin-bottom: 20px;
}
.status-online { border-color: #28a745; color: #28a745; }
.status-offline { border-color: #dc3545; color: #dc3545; }
.form-label { color: #00ffea; font-weight: bold; text-align: left; }
.btn-log {
  background-color: #00ffea; color: #000; font-weight: bold;
  border-radius: 10px; padding: 10px 30px; margin-top: 10px;
}
.btn-log:hover { background-color: #00c4b3; color: #fff; }
.modal-content { background-color: #111; color: #00ffea; }
.modal-header, .modal-footer { border-color: #00ffea; }
.modal-body { max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
.input-icon { display: flex; align-items: center; justify-content: center; }
.input-icon i { margin-right: 10px; }
.developer-caption {
  color: #00ffea;
  font-size: 0.9rem;
  margin-top: 5px;
}
</style>
</head>
<body>

<h1>Power Cut Detecting System</h1>

<div class="container" style="max-width: 400px;">

  <!-- Battery Percentage -->
  <label class="form-label">Battery Percentage</label>
  <div class="input-icon">
    <i class="bi bi-battery-half"></i>
    <input type="text" class="form-control" value="72%" readonly>
  </div>

  <!-- Current Status -->
  <label class="form-label">Current Status</label>
  <div class="input-icon">
    <i class="bi bi-lightning-fill"></i>
    <input type="text" id="currentStatus" class="form-control" readonly>
  </div>

  <!-- WiFi Status -->
  <label class="form-label">WiFi Status</label>
  <div class="input-icon">
    <i class="bi bi-wifi"></i>
    <input type="text" id="wifiStatus" class="form-control" value="Offline" readonly>
  </div>

  <!-- Last Updated -->
  <label class="form-label">Last Updated</label>
  <div class="input-icon">
    <i class="bi bi-clock"></i>
    <input type="text" id="timestamp" class="form-control" readonly>
  </div>

  <!-- View Log -->
  <button type="button" class="btn btn-log" data-bs-toggle="modal" data-bs-target="#logModal">
    <i class="bi bi-file-text"></i> View Log
  </button>

  <!-- Developer Caption -->
  <div class="developer-caption">
    Developed By Steve || Pankaj || Murthfa
  </div>

</div>

<!-- Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logModalLabel">Arduino Log</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="logOutput">Loading log...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-log" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Sound -->
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let lastStatus = null; // prevents notification on first load

// Request notification permission
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Utility function to capitalize
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Fetch Arduino status
async function fetchStatus() {
  try {
    const response = await fetch('read_serial.php');
    const data = await response.json();

    const currentStatus = document.getElementById('currentStatus');
    const wifiStatus = document.getElementById('wifiStatus');
    const newStatus = (data.status || 'Offline').toLowerCase();

    // Update Current and WiFi Status colors and values
    if (newStatus === 'online') {
      currentStatus.className = 'form-control status-online';
      wifiStatus.className = 'form-control status-online';
    } else {
      currentStatus.className = 'form-control status-offline';
      wifiStatus.className = 'form-control status-offline';
    }
    currentStatus.value = capitalize(newStatus);
    wifiStatus.value = capitalize(newStatus);

    // Update timestamp
    document.getElementById('timestamp').value = data.timestamp || '--';

    // Notification only if status changes and lastStatus is not null
    if (lastStatus !== null && lastStatus !== newStatus) {
      if (newStatus === 'offline') {
        document.getElementById('alertSound').play();
        if (Notification.permission === "granted") {
          new Notification("⚠️ Power Cut Detected", {
            body: `Status changed: ${capitalize(lastStatus)} → Offline`,
            icon: "https://cdn-icons-png.flaticon.com/512/285/285812.png"
          });
        }
      } else if (newStatus === 'online') {
        if (Notification.permission === "granted") {
          new Notification("✅ Power Restored", {
            body: `Status changed: ${capitalize(lastStatus)} → Online`,
            icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
          });
        }
      }
    }

    lastStatus = newStatus;

  } catch (error) {
    console.error('Error fetching status:', error);
  }
}

// Fetch Arduino log
async function fetchLog() {
  try {
    const response = await fetch('arduino_log.txt');
    const logText = await response.text();
    const logOutput = document.getElementById('logOutput');

    const lines = logText.trim().split('\n');
    if (lines.length === 0 || (lines.length === 1 && lines[0] === "")) {
      logOutput.innerHTML = "<p>No logs available.</p>";
      return;
    }

    let html = "<ul style='list-style:none; padding-left:0; text-align:left;'>";
    lines.forEach(line => {
      html += `<li style="border-bottom:1px solid #00ffea; padding:5px 0;">${line}</li>`;
    });
    html += "</ul>";
    logOutput.innerHTML = html;

  } catch (error) {
    document.getElementById('logOutput').textContent = "Unable to load log.";
    console.error('Error fetching log:', error);
  }
}

// Auto-update status every 1 second
fetchStatus();
setInterval(fetchStatus, 1000);

// Load log on modal open
const logModal = document.getElementById('logModal');
logModal.addEventListener('show.bs.modal', fetchLog);
</script>

</body>
</html>
