<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Power Cut Detecting System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
  background-color: #000;
  color: #fff;
  text-align: center;
  padding: 50px;
}
h1 { color: #00ffea; margin-bottom: 40px; }
.form-control {
  background-color: #111;
  color: #fff;
  border: 1px solid #00ffea;
  border-radius: 10px;
  text-align: center;
  font-weight: bold;
  margin-bottom: 20px;
}
.status-online { border-color: #28a745; color: #28a745; }
.status-offline { border-color: #dc3545; color: #dc3545; }
.form-label { color: #00ffea; font-weight: bold; text-align: left; }
.btn-log {
  background-color: #00ffea; color: #000; font-weight: bold;
  border-radius: 10px; padding: 10px 30px; margin-top: 10px;
}
.btn-log:hover { background-color: #00c4b3; color: #fff; }
.modal-content { background-color: #111; color: #00ffea; }
.modal-header, .modal-footer { border-color: #00ffea; }
.modal-body { max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
.input-icon { display: flex; align-items: center; justify-content: center; }
.input-icon i { margin-right: 10px; }
</style>
</head>
<body>

<h1>Power Cut Detecting System</h1>

<div class="container" style="max-width: 400px;">

  <!-- Battery Percentage -->
  <label class="form-label">Battery Percentage</label>
  <div class="input-icon">
    <i class="bi bi-battery-half"></i>
    <input type="text" class="form-control" value="72%" readonly>
  </div>

  <!-- Current Status -->
  <label class="form-label">Current Status</label>
  <div class="input-icon">
    <i class="bi bi-lightning-fill"></i>
    <input type="text" id="currentStatus" class="form-control" readonly>
  </div>

  <!-- Last Updated -->
  <label class="form-label">Last Updated</label>
  <div class="input-icon">
    <i class="bi bi-clock"></i>
    <input type="text" id="timestamp" class="form-control" readonly>
  </div>

  <!-- View Log -->
  <button type="button" class="btn btn-log" data-bs-toggle="modal" data-bs-target="#logModal">
    <i class="bi bi-file-text"></i> View Log
  </button>

</div>

<!-- Modal -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logModalLabel">Arduino Log</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="logOutput">Loading log...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-log" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Sound -->
<audio id="alertSound" src="alert.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let lastStatus = '';

// Request notification permission
if (Notification.permission !== "granted") {
  Notification.requestPermission();
}

async function fetchStatus() {
  try {
    const response = await fetch('read_serial.php');
    const data = await response.json();

    const currentStatus = document.getElementById('currentStatus');
    const newStatus = data.status || 'Offline';

    if (newStatus.toLowerCase() === 'online') {
      currentStatus.className = 'form-control status-online';
    } else {
      currentStatus.className = 'form-control status-offline';
    }
    currentStatus.value = newStatus;

    document.getElementById('timestamp').value = data.timestamp || '--';

    // Notification + sound on status change
    if (lastStatus && lastStatus !== newStatus) {
      if (newStatus.toLowerCase() === 'offline') {
        // Play sound
        document.getElementById('alertSound').play();

        // Show desktop notification
        if (Notification.permission === "granted") {
          new Notification("⚠️ Power Cut Detected", {
            body: `Status changed: ${lastStatus} → ${newStatus}`,
            icon: "https://cdn-icons-png.flaticon.com/512/285/285812.png" // example icon
          });
        }
      } else {
        // Optional: notify when back online
        if (Notification.permission === "granted") {
          new Notification("✅ Power Restored", {
            body: `Status changed: ${lastStatus} → ${newStatus}`,
            icon: "https://cdn-icons-png.flaticon.com/512/190/190411.png"
          });
        }
      }
    }

    lastStatus = newStatus;

  } catch (error) {
    console.error('Error fetching status:', error);
  }
}

async function fetchLog() {
  try {
    const response = await fetch('arduino_log.txt');
    const logText = await response.text();
    document.getElementById('logOutput').textContent = logText;
  } catch (error) {
    document.getElementById('logOutput').textContent = "Unable to load log.";
    console.error('Error fetching log:', error);
  }
}

// Auto-update
fetchStatus();
setInterval(fetchStatus, 1000);

// Load log on modal open
const logModal = document.getElementById('logModal');
logModal.addEventListener('show.bs.modal', fetchLog);
</script>

</body>
</html>
